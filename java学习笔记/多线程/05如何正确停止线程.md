# 如何正确停止线程

## 1.停止线程的正确方法(重要、难点)

### 1.1 原理介绍

使用interrupt来通知，而不是强制。告诉，通知线程中断，停止。线程本身具有决定权，需不需要停止。

什么情况下需要停止线程？

例如：系统需要中断，程序运行超时，

### 1.2 如何正确停止线程

#### 1.2.1 通常线程会在什么情况下停止？

​	 run方法执行完毕

​	 线程出现异常，没有被捕获

##### 1.2.2 正确的停止的方法： interrupt

##### (1) 通常线程会在什么情况下停止？ 普通情况

```java
public class RightWayStopThreadWithoutSleep  implentes Runnable{
    @Override
    public void run() {
        int num = 0;
        
        while (！Thread.isInterrupt() &&num <= Integer.MAX_VALUE / 2) {
            if (num %10000 == 0) {
                sout(num+"是10000的倍数");
            }
            num++;
        }
        sout("任务运行成功");
    }
    public static void main (String [] args) throw Exception{
        Thread thread = new Thread(new RightWatyStopThreadWithoutSleep());
        thread.start();
        Thread.sleep(1000);
        //主线程不会停止，还需时刻要判断是否已经中断
        thread.interrupt();
    }
}
```



#####   (2) 线程可能被阻塞

```java
//带有sleep的中断线程的写法
public class stopThreadWithSleep {
    //带有sleep的中断线程的写法
        public static void main(String args[]) throws InterruptedException{
            Runnable runnable = ()->{
                //打印出100的倍数
                int num = 0;
                try{
                    while (num <=300 && !Thread.currentThread().isInterrupted()) {
                        if (num % 100 ==0 ){
                            System.out.println("是100的倍数" + num);
                        }
                        num++;
                    }
                    Thread.sleep(1000);
                }
                catch (InterruptedException e) {
                    //线程可能被阻塞，响应响应中断线程的
                    e.printStackTrace();
                }
            };
            Thread thread = new Thread(runnable);
            thread.start();
            Thread.sleep(500);
            //线程正在sleep中，此时中断，会抛出字段异常
            thread.interrupt();
        }
}

```



#####   (3) 如果线程在每次迭代后都阻塞

​	for 循环

如果在执行过程中，每次循环都回调用sleep方法或wait。

```java
//带有sleep的中断线程的写法
public class stopThreadWithSleep {
    //带有sleep的中断线程的写法
        public static void main(String args[]) throws InterruptedException{
            Runnable runnable = ()->{
                //打印出100的倍数
                int num = 0;
                try{
                    while (num <=3000 ) {
                        //如果在循环会出现线程被阻塞的情况，就不需要在每次迭代加入interrupt判断
                        if (num % 100 ==0 ){
                            System.out.println("是100的倍数" + num);
                        }
                        num++;
                        Thread.sleep(10);

                    }
                }
                catch (InterruptedException e) {
                    //线程可能被阻塞，响应响应中断线程的
                    e.printStackTrace();
                }
            };
            Thread thread = new Thread(runnable);
            thread.start();
            Thread.sleep(5000);
            //线程正在sleep中，此时中断，会抛出字段异常
            thread.interrupt();
        }
}
```



### 1.3 错误的停止方法

1.3.1 while

如果while里面放try/catch，会导致中断线程失效

```java
  public static void main(String[] args) throws InterruptedException {
        Runnable runnable = () -> {
            int num = 0;
            //try {
            //interrupted执行后将状态标志清除为false的功能
            //isInterrupted()，测试线程thread对象是否已经进入中断状态，但不清楚状态标志
            while (num <= 10000 && ! Thread.currentThread().isInterrupted()) {
                if (num % 100 == 0) {
                    System.out.println("是100的倍数" + num);
                }
                num++;
                try {
                    Thread.sleep(10);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
            //}
        };

        Thread thread = new Thread(runnable);
        thread.start();

        Thread.sleep(5000);
        thread.interrupt();
    }
```



### 1.4 停止线程相关的重要函数解析

实际开发中的最佳两种方式

1.4.1 优先选择：传递中断



1.4.2 不想或无法传递：恢复中断



1.4.3 不应屏蔽中断

### 1.5 常见面试问题

1.5.1 如何停止一个线程？



1.2.2 如何处理不可中断的阻塞(例如抢锁时Reetlock)